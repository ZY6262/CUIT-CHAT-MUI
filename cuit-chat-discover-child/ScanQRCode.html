<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/header.css" type="text/css" rel="stylesheet" />
		<style type="text/css">
			#scanComponent {
				width: 100%;
				top: 44px;
				bottom: 0px;
				position: absolute;
				text-align: center;
				background-color: #000000;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav title">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;"></a>
			<h1 class="mui-title title-color"><b>扫一扫</b></h1>
			<a id="openPhotos" class="mui-icon mui-icon-right-nav mui-pull-right" style="font-size: 25px;color: white;">
				<img src="../image/album.png" style="width: 24px">
			</a>
		</header>
		<div id="scanComponent">
			
		</div>
		
		
	</body>
		<script src="../js/mui.js"></script>
		<script type="text/javascript" src="../js/app.js"></script>
		<script type="text/javascript" src="../js/myserver.js"></script>
		<script type="text/javascript" src="../js/fastdfs.js"></script>
		<script type="text/javascript">
			
			var scan;
			
			mui.init({
				swipeBack: true
			});
			
			mui.plusReady(function () {
				
				var self = plus.webview.currentWebview();
				var openPhotos = document.getElementById('openPhotos');
				
				// 直接扫描二维码
				setTimeout("startScan()", 500);
				
				// 从图片中选择二维码
				openPhotos.addEventListener('tap', function(){
					plus.gallery.pick(function(path){
							plus.barcode.scan(path, function(type,result){
								operateScanResult(result);
							}, function(error){
								console.log("Scan failed: "+JSON.stringify(error));
							});
						}, function(error){
						}, {filter:"image"},
					);
				});
				
				
			});
			
			function startScan(){
				scan = plus.barcode.create('scanComponent', null,  {frameColor: '#1973ba', scanbarColor: '#1973ba'})
				// scan = new plus.barcode.Barcode();
				scan.onmarked = onmarked;
				plus.webview.currentWebview().append(scan);
				scan.start();
			};
			
			function onmarked(type, result){
				operateScanResult(result);
			};
			
			function operateScanResult(result){
				var encodeStr;
				try {
					encodeStr = atob(result);
				} catch (error) {
					mui.alert(result, '扫一扫', '好', function(){
						setTimeout(function(){
							scan.start();
						}, 2000);
					});
					return;
				}
				var content = encodeStr.split("cuit_chat:");
				if (content.length != 2){					
					mui.alert(result, '扫一扫', '好', function(){
						setTimeout(function(){
							scan.start();
						}, 2000);
					});
				} else {
					// 调用ajax与后端通信，查看该用户
					plus.nativeUI.showWaiting('处理中...');
					setTimeout(function(){
						myserver.searchByUsername(content[1]);
					}, 2000);
				}
				// scan到了一个二维码就会停止，所以需要恢复二维码扫描
			}
		</script>
</html>
